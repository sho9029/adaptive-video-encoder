# Video Encoder

画質劣化を抑えつつファイルサイズを削減することを目的とした、Python製の動画再エンコードツールです。
NVIDIA GPU (NVENC) を活用した AV1 エンコードをデフォルトとし、SSIM (Structural Similarity) による自動画質保証機能を備えています。

## 特徴

*   **高圧縮・高画質**: デフォルトで AV1 (NVENC) コーデックを使用し、Visually Lossless（見た目の劣化なし）な設定でエンコードします。
*   **自動画質保証 (SSIM)**: エンコード後に SSIM を計算し、基準値（デフォルト 0.985）を下回った場合は自動的に画質設定を上げて再エンコードします。
*   **メタデータ対応**: 出力形式に MP4 (`.mp4`) を採用。Windows エクスプローラーでビットレートやフレームレートなどの詳細情報を確認できます。
*   **スマートな音声処理**: ソースが AAC の場合は無劣化コピーし、それ以外の場合はソースのビットレートを維持して AAC に変換します。
*   **安全設計**:
    *   **解像度チェック**: 意図しないリサイズが発生していないかエンコード後に検証します。
*   **スマートなファイル管理**: 動画以外のファイル（画像、テキスト等）はエンコードせずにそのままターゲットディレクトリにコピーし、全体のディレクトリ構造を維持します。
*   **厳密な動画判定**: 拡張子、フレーム数、継続時間に基づき、処理対象が「本物の動画」であるかを判定します。画像（PNG等）が動画化されることはありません。
    *   **順序保証**: ファイル名順（昇順）に処理を行うため、ログの確認や進捗管理が容易です。
*   **便利なログ**: エンコード成功時に、ファイルサイズの削減量と削減率 (%) を表示します。

## 必要要件

*   **OS**: Windows (推奨)
*   **Python**: 3.8 以上
*   **FFmpeg**: NVENC 対応ビルド（パスが通っていること）
    *   `ffmpeg` および `ffprobe` コマンドが必要です。
*   **GPU**: NVIDIA GeForce RTX 40シリーズ以上 (AV1 NVENC利用時)
    *   ※H.265/H.264 NVENC利用の場合は、対応する旧世代GPUでも動作可能

## 使い方

### 基本的な使用法

```powershell
python video_encoder.py "入力ディレクトリパス" "出力ディレクトリパス"
```

### オプション

*   `--codec`: コーデック指定 (デフォルト: `av1_nvenc`)
    *   `av1_nvenc`, `hevc_nvenc`, `libx265`, `libx264`
*   `--quality`: 画質設定値 (CQ または CRF)。デフォルト値はコーデックにより最適化されています（例: AV1 NVENC=38）。
*   `--preset`: エンコードプリセット (デフォルト: `p7` 等)
*   `--min-ssim`: 自動再エンコードの基準となるSSIM閾値（下限） (デフォルト: `0.985`)
*   `--max-ssim`: SSIMの上限閾値。これを超えると圧縮率を上げます (デフォルト: `1.0`)
*   `--max-retries`: 再エンコードの最大試行回数 (デフォルト: `3`)

### 実行例

**AV1 (NVENC) でエンコード（デフォルト）**
```powershell
python video_encoder.py "C:\Videos\Source" "C:\Videos\Encoded"
```

**H.265 (NVENC) を使用**
```powershell
python video_encoder.py "C:\Videos\Source" "C:\Videos\Encoded" --codec hevc_nvenc
```

**SSIM基準値を厳しくする**
```powershell
python video_encoder.py "C:\Videos\Source" "C:\Videos\Encoded" --min-ssim 0.99
```

## 動作の仕組み

### 1. 処理対象の自動判定
ディレクトリ内を走査し、拡張子だけでなく、実際の映像ストリームの有無やフレーム数を確認します。これにより、画像ファイルや破損したファイルを誤って処理することを防ぎます。

### 2. フィードバック制御による品質保証
エンコード完了後にソースファイルと生成ファイルを比較し、SSIM（構造的類似性）を計測します。
- **画質不足の場合**: 自動的にパラメータを調整（画質を向上）して再エンコードします。
- **過剰画質の場合**: 必要以上にファイルサイズが大きくならないよう、圧縮率を高めて再試行します。

このループを指定回数繰り返すことで、目標とする品質を確実に達成します。
